package keeper_test

import (
	"crypto/sha256"
	"testing"

	"github.com/stretchr/testify/require"

	jwkMsgServer "github.com/burnt-labs/xion/x/jwk/keeper"
	jwktypes "github.com/burnt-labs/xion/x/jwk/types"
)

func TestAudienceDuplicateVulnerability(t *testing.T) {
	k, ctx := setupKeeper(t)
	admin := "cosmos1e2fuwe3uhq8zd9nkkk876nawrwdulgv4cxkq74"

	msgServer := jwkMsgServer.NewMsgServerImpl(k)

	// Create audience claim
	sum := sha256.Sum256([]byte("test-aud"))
	_, err := msgServer.CreateAudienceClaim(ctx, &jwktypes.MsgCreateAudienceClaim{
		Admin:   admin,
		AudHash: sum[:],
	})
	require.NoError(t, err)

	// Create initial audience
	_, err = msgServer.CreateAudience(ctx, &jwktypes.MsgCreateAudience{
		Admin: admin,
		Aud:   "test-aud",
		Key:   "initial-key",
	})
	require.NoError(t, err)

	// Check initial state
	allAudiences := k.GetAllAudience(ctx)
	require.Len(t, allAudiences, 1, "Should have exactly 1 audience initially")

	initialAudience, found := k.GetAudience(ctx, "test-aud")
	require.True(t, found, "Initial audience should exist")
	require.Equal(t, "initial-key", initialAudience.Key, "Initial key should match")

	// Try to update with only Key change - this is where the vulnerability is claimed to be
	_, err = msgServer.UpdateAudience(ctx, &jwktypes.MsgUpdateAudience{
		Admin:    admin,
		NewAdmin: admin, // Keep same admin
		Aud:      "test-aud",
		Key:      "updated-key",
		NewAud:   "", // Empty NewAud - this is the key part of the vulnerability claim
	})
	require.NoError(t, err)

	// Check final state - this is where we test if duplicates were created
	allAudiences = k.GetAllAudience(ctx)
	require.Len(t, allAudiences, 1, "Should still have exactly 1 audience after update - NO DUPLICATES!")

	// Check if we can retrieve the audience and if it was properly updated
	audience, found := k.GetAudience(ctx, "test-aud")
	require.True(t, found, "Audience should still exist after update")
	require.Equal(t, "updated-key", audience.Key, "Key should be updated")
	require.Equal(t, admin, audience.Admin, "Admin should remain the same")
	require.Equal(t, "test-aud", audience.Aud, "Aud should remain the same")

	t.Logf("Test completed successfully. No duplicates were created.")
	t.Logf("Final audience count: %d", len(allAudiences))
	t.Logf("Final audience: Aud=%s, Admin=%s, Key=%s", audience.Aud, audience.Admin, audience.Key)
}
