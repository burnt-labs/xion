package types_test

import (
	"testing"

	"github.com/stretchr/testify/require"

	sdk "github.com/cosmos/cosmos-sdk/types"

	"github.com/burnt-labs/xion/x/zk/types"
)

// Valid vkey bytes for testing (from existing test fixtures)
var validVKeyBytes = []byte(`{"protocol":"groth16","curve":"bn128","nPublic":38,"vk_alpha_1":["20491192805390485299153009773594534940189261866228447918068658471970481763042","9383485363053290200918347156157836566562967994039712273449902621266178545958","1"],"vk_beta_2":[["6375614351688725206403948262868962793625744043794305715222011528459656738731","4252822878758300859123897981450591353533073413197771768651442665752259397132"],["10505242626370262277552901082094356697409835680220590971873171140371331206856","21847035105528745403288232691147584728191162732299865338377159692350059136679"],["1","0"]],"vk_gamma_2":[["10857046999023057135944570762232829481370756359578518086990519993285655852781","11559732032986387107991004021392285783925812861821192530917403151452391805634"],["8495653923123431417604973247489272438418190587263600148770280649306958101930","4082367875863433681332203403145435568316851327593401208105741076214120093531"],["1","0"]],"vk_delta_2":[["15077028419523802218068800711765892220007704101776825737873498462523243974011","21035432942633023563568649328632676616806345190265721806958729811352423617078"],["19557127063776667950420308021890134701214219557891223581756933481287479566633","846877808733141898933269498060926622823200991369227170080032302022497893186"],["1","0"]],"vk_alphabeta_12":[[["2029413683389138792403550203267699914886160938906632433982220835551125967885","21072700047562757817161031222997517981543347628379360635925549008442030252106"],["5940354580057074848093997050200682056184807770593307860589430076672439820312","12156638873931618554171829126792193045421052652279363021382169897324752428276"],["7898200236362823042373859371574133993780991612861777490112507062703164551277","7074218545237549455313236346927434013100842096812539264420499035217050630853"]],[["7077479683546002997211712695946002074877511277312570035766170199895071832130","10093483419865920389913245021038182291233451549023025229112148274109565435465"],["4595479056700221319381530156280926371456704509942304414423590385166031118820","19831328484489333784475432780421641293929726139240675179672856274388269393268"],["11934129596455521040620786944827826205713621633706285934057045369193958244500","8037395052364110730298837004334506829870679138539351714161922535653966267665"]]],"IC":[["15862126421713956100993553801681385807071251923202096057307112802014733741378","13108645471998862676498660499963950655089157405079199301326521022095491980050","1"],["21715368734116209877917737472988550416427108747767751044339655343738713294081","16899680151032020137316253115554651362124948058456073805307693594940894296737","1"],["15262990638665614060530787821677588373695066693663158063982759218486893877667","2420030994339659044877551774878879579539478107604084928775920288418445748893","1"],["4779631002371829799891865333523285150824571063171838795714217569409700067901","10546445482953855922964557343350689423745005556375215568946455178548440545451","1"],["9741084082692311031380832786842627774447531944978570973019980411335024133911","6456765607653731224719286422851134035027820735266671471260965034155067558095","1"],["6313998054097328821530449700944109518655673497422090287224937403442256849892","8949046854518033665920516152867689087361761776592028552813706331846080436127","1"],["19455004505330447875464891456131779706172878161495108647239408156697860781015","10700363389741151350277597241668096298740064310948926498795939028803698771256","1"],["11095436403959858714632014660512186798714489956571209173197599613073498921971","13346994434098863076098889620917854024750421111596696725604624024179182893316","1"],["1671036926138055226340758221464363182130776093421093632132737591426614298925","20729638678345866741606989062234356779080360679598711914882600998822423673637","1"],["11851780037697614254474094672033501462727753040036868756575216082055866286032","1440831541953108707746399051091098768339498981076255077398930997631136398255","1"],["13262822659168178538107562565476291921784278416046906012160287838437956361544","8968704945653882159429633456276740310246740279948513040927859285737795803063","1"],["14671716097218798296995766350401639065800063316592869009481261504951456024111","7521809615837653588084093900233146949194992052195718889955963052853593127851","1"],["12954170130919025831610184394457582767063018799510912367268424929794875127056","2084831424799211498149076498721813449003756656878644044116668291577602505425","1"],["12632933855373090743215354268952430175937623477220234605279513070032688665624","3091219453851381009330847225785936380603094667508649419744929316408813085047","1"],["11693329906447319738519656378461689738684871618054632110647690123314047666104","16115632890530096069009774921426505901391139056787913041362676835015285922055","1"],["15228920866099627524717212988813508092151117792759104691802287066313620621024","18820108700785092540453277256476913744616513620780441992332958666693169893839","1"],["12261649993760828007952244968605529429657705314456718055527063737309587671042","5870994632675136339633665313413771206060428293706997911461183436690556555614","1"],["11629192308017232834272426055641054472690440628760420893768425265842901694927","10423817109277656361785929772949488270714243173459585665123238412623441908044","1"],["20422904905668312539879549474966549677978835915618446420076798157316819718009","12100313756943566737232138055462065846217477839991595426014295505080704407953","1"],["21476342167949309556946055779217073807091428432091660429675028767659252261621","15032927025024086498459117343324916538621879209152542014313282755063764830633","1"],["19667854955741407551080999831428267915569766344426831628247675501923896692139","6859680690230560177797752919787302912528108735076608426171454913169479495583","1"],["5820766029026347188900703479295044609282207835660715570755532256704809441652","6665063628227195881056679259997591002119949178176152576266356102949523648365","1"],["4960609673311528780970476169541831330525015115903022679769564188866770533974","18498016592706636877507588419852933006654448193575236587820027990256028656291","1"],["2618440399489867667750736045976395657670012509048255289296064263671672032391","2610195953915327266432426808538345783069350149048853889684032464488010682696","1"],["8946266026029866001296541935406628568000814810935364771346891604434712965219","17168825929298426668893609447403448674372567095246564652697219571073323509855","1"],["7268102181531648061970720817496125847253454851454330367044447012199697407889","16893803605867034449971052617566645989043543954046054517760665682590771180720","1"],["17936574631980816231963821352494538667063987266405188686932164610547910000927","14619366797736390188682063557691929891712501731875979809012384811449088180595","1"],["2555126677814227990997153440827801575199688892120866878028230174827854014829","4728166826570131119728685949614640126617556919884566416296117148979906509611","1"],["10178419356804051761995495990050514099356535127498836812081831657125690940203","12451236771596846966012734124929880748330431615188135681179581245048929459564","1"],["10638696802009595065498152028631282992987648838389879125728298631594325927557","3355028107306679274430988014497908813008051508889579206556277058766038545835","1"],["1880862816476456282684418534180282555565750874645091859063203163706583998656","14879116066021784424780856734234098733587088046938536203838854756802229280839","1"],["18285711080508193700983099765917475624562023098158101561703896832668896333217","7316892178793315566800129392439195648017654917825661851697960117696709296379","1"],["17893336934306815619296403632176116693393149164810697818904855215514146686661","8287088550073217552041469912217706400697097231508889949313266746234728584974","1"],["17085927490186217933054470455374458767581858978877770735936627539318674568600","16953831619007335037961096054616893116820688797276051153330978319935197037440","1"],["20825422678489605487259659746786753347587793057824424481233424589760824721880","17779929277003807664576494001402179536685630859073326553217389496927126714549","1"],["3685095050725952547545657644399155646569828417927474620536754765304709954847","3684820029704914524464673696432875296612866178576920975653851286677687219563","1"],["20893296921673518355389817003295762192693566310787576490393613715093874118541","17988411626434381411896152430267918631247783442632697497165731034538176898737","1"],["18227987569051476507027418556892684427102239431531802009341058092380803802476","20889269199674078451939461556977077288519349629964336241604558292689471668016","1"],["14259903774353292053256866934077879612969471711375074208788936135453722538995","6095927912052891896392527778641079207799735311024547671830149076891386197461","1"]]}`)

func encodedValidVKeyBytes() []byte {
	return validVKeyBytes
}

// getValidAuthority returns a valid bech32 address for testing
func getValidAuthority() string {
	addr := sdk.AccAddress([]byte("test_authority_addr_"))
	return addr.String()
}

func TestMsgAddVKey_ValidateBasic(t *testing.T) {
	validAuthority := getValidAuthority()

	t.Run("valid message", func(t *testing.T) {
		msg := &types.MsgAddVKey{
			Authority: validAuthority,
			Name:      "test-vkey",
			VkeyBytes: encodedValidVKeyBytes(),
		}
		err := msg.ValidateBasic()
		require.NoError(t, err)
	})

	t.Run("invalid authority address", func(t *testing.T) {
		msg := &types.MsgAddVKey{
			Authority: "invalid-address",
			Name:      "test-vkey",
			VkeyBytes: encodedValidVKeyBytes(),
		}
		err := msg.ValidateBasic()
		require.Error(t, err)
		require.Contains(t, err.Error(), "invalid authority address")
	})

	t.Run("empty authority address", func(t *testing.T) {
		msg := &types.MsgAddVKey{
			Authority: "",
			Name:      "test-vkey",
			VkeyBytes: encodedValidVKeyBytes(),
		}
		err := msg.ValidateBasic()
		require.Error(t, err)
		require.Contains(t, err.Error(), "invalid authority address")
	})

	t.Run("empty name", func(t *testing.T) {
		msg := &types.MsgAddVKey{
			Authority: validAuthority,
			Name:      "",
			VkeyBytes: encodedValidVKeyBytes(),
		}
		err := msg.ValidateBasic()
		require.Error(t, err)
		require.Contains(t, err.Error(), "name cannot be empty")
	})

	t.Run("empty vkey bytes", func(t *testing.T) {
		msg := &types.MsgAddVKey{
			Authority: validAuthority,
			Name:      "test-vkey",
			VkeyBytes: []byte{},
		}
		err := msg.ValidateBasic()
		require.Error(t, err)
		require.Contains(t, err.Error(), "vkey_bytes cannot be empty")
	})

	t.Run("nil vkey bytes", func(t *testing.T) {
		msg := &types.MsgAddVKey{
			Authority: validAuthority,
			Name:      "test-vkey",
			VkeyBytes: nil,
		}
		err := msg.ValidateBasic()
		require.Error(t, err)
		require.Contains(t, err.Error(), "vkey_bytes cannot be empty")
	})

	t.Run("invalid vkey bytes", func(t *testing.T) {
		msg := &types.MsgAddVKey{
			Authority: validAuthority,
			Name:      "test-vkey",
			VkeyBytes: []byte("invalid-vkey-data"),
		}
		err := msg.ValidateBasic()
		require.Error(t, err)
		require.Contains(t, err.Error(), "invalid vkey_bytes")
	})
}

func TestMsgUpdateVKey_ValidateBasic(t *testing.T) {
	validAuthority := getValidAuthority()

	t.Run("valid message", func(t *testing.T) {
		msg := &types.MsgUpdateVKey{
			Authority: validAuthority,
			Name:      "test-vkey",
			VkeyBytes: encodedValidVKeyBytes(),
		}
		err := msg.ValidateBasic()
		require.NoError(t, err)
	})

	t.Run("invalid authority address", func(t *testing.T) {
		msg := &types.MsgUpdateVKey{
			Authority: "invalid-address",
			Name:      "test-vkey",
			VkeyBytes: encodedValidVKeyBytes(),
		}
		err := msg.ValidateBasic()
		require.Error(t, err)
		require.Contains(t, err.Error(), "invalid authority address")
	})

	t.Run("empty authority address", func(t *testing.T) {
		msg := &types.MsgUpdateVKey{
			Authority: "",
			Name:      "test-vkey",
			VkeyBytes: encodedValidVKeyBytes(),
		}
		err := msg.ValidateBasic()
		require.Error(t, err)
		require.Contains(t, err.Error(), "invalid authority address")
	})

	t.Run("empty name", func(t *testing.T) {
		msg := &types.MsgUpdateVKey{
			Authority: validAuthority,
			Name:      "",
			VkeyBytes: encodedValidVKeyBytes(),
		}
		err := msg.ValidateBasic()
		require.Error(t, err)
		require.Contains(t, err.Error(), "name cannot be empty")
	})

	t.Run("empty vkey bytes", func(t *testing.T) {
		msg := &types.MsgUpdateVKey{
			Authority: validAuthority,
			Name:      "test-vkey",
			VkeyBytes: []byte{},
		}
		err := msg.ValidateBasic()
		require.Error(t, err)
		require.Contains(t, err.Error(), "vkey_bytes cannot be empty")
	})

	t.Run("nil vkey bytes", func(t *testing.T) {
		msg := &types.MsgUpdateVKey{
			Authority: validAuthority,
			Name:      "test-vkey",
			VkeyBytes: nil,
		}
		err := msg.ValidateBasic()
		require.Error(t, err)
		require.Contains(t, err.Error(), "vkey_bytes cannot be empty")
	})
}

func TestMsgRemoveVKey_ValidateBasic(t *testing.T) {
	validAuthority := getValidAuthority()

	t.Run("valid message", func(t *testing.T) {
		msg := &types.MsgRemoveVKey{
			Authority: validAuthority,
			Name:      "test-vkey",
		}
		err := msg.ValidateBasic()
		require.NoError(t, err)
	})

	t.Run("invalid authority address", func(t *testing.T) {
		msg := &types.MsgRemoveVKey{
			Authority: "invalid-address",
			Name:      "test-vkey",
		}
		err := msg.ValidateBasic()
		require.Error(t, err)
		require.Contains(t, err.Error(), "invalid authority address")
	})

	t.Run("empty authority address", func(t *testing.T) {
		msg := &types.MsgRemoveVKey{
			Authority: "",
			Name:      "test-vkey",
		}
		err := msg.ValidateBasic()
		require.Error(t, err)
		require.Contains(t, err.Error(), "invalid authority address")
	})

	t.Run("empty name", func(t *testing.T) {
		msg := &types.MsgRemoveVKey{
			Authority: validAuthority,
			Name:      "",
		}
		err := msg.ValidateBasic()
		require.Error(t, err)
		require.Contains(t, err.Error(), "name cannot be empty")
	})
}

func TestMsgUpdateParams_ValidateBasic(t *testing.T) {
	validAuthority := getValidAuthority()

	t.Run("valid message", func(t *testing.T) {
		msg := &types.MsgUpdateParams{
			Authority: validAuthority,
			Params:    types.DefaultParams(),
		}
		err := msg.ValidateBasic()
		require.NoError(t, err)
	})

	t.Run("invalid authority address", func(t *testing.T) {
		msg := &types.MsgUpdateParams{
			Authority: "bad-authority",
			Params:    types.DefaultParams(),
		}
		err := msg.ValidateBasic()
		require.Error(t, err)
		require.Contains(t, err.Error(), "invalid authority address")
	})

	t.Run("invalid params", func(t *testing.T) {
		msg := &types.MsgUpdateParams{
			Authority: validAuthority,
			Params: types.Params{
				MaxVkeySizeBytes: 0,
				UploadChunkSize:  1,
				UploadChunkGas:   1,
			},
		}
		err := msg.ValidateBasic()
		require.Error(t, err)
		require.Contains(t, err.Error(), "max_vkey_size_bytes must be positive")
	})
}

func TestMsgUpdateParams_GetSigners(t *testing.T) {
	authority := getValidAuthority()
	msg := &types.MsgUpdateParams{
		Authority: authority,
		Params:    types.DefaultParams(),
	}

	signers := msg.GetSigners()
	require.Len(t, signers, 1)
	require.Equal(t, authority, signers[0].String())
}

func TestMsgTypes_ImplementSdkMsg(t *testing.T) {
	t.Run("MsgAddVKey implements sdk.Msg", func(t *testing.T) {
		var _ sdk.Msg = &types.MsgAddVKey{}
	})

	t.Run("MsgUpdateVKey implements sdk.Msg", func(t *testing.T) {
		var _ sdk.Msg = &types.MsgUpdateVKey{}
	})

	t.Run("MsgRemoveVKey implements sdk.Msg", func(t *testing.T) {
		var _ sdk.Msg = &types.MsgRemoveVKey{}
	})
}
